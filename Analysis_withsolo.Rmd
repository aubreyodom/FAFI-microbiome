---
title: "Sepsis Analysis"
author: "Aubrey Odom-Mabey"
date: '2022-11-01'
output: html_document
---

# Setup
```{r setup, message = FALSE}
suppressPackageStartupMessages({
  # General use
  library(tidyverse)
  library(knitr)
  library(magrittr)
  # Data formats
  library(animalcules)
  library(MultiAssayExperiment)
  library(SummarizedExperiment)
  # Modeling
  library(lme4)
  library(geepack)
  # Plotting
  library(alluvial)
  library(ggeffects)
  library(emmeans)
})
```

# Extract data
```{r}
# Read in MAE of data
OG_dat <- readRDS("Data/animalcules_0.05pct.rds")
dat <- OG_dat[["MicrobeGenetics"]]

# Extract metadata, taxonomic info, and counts
tax_table <- as.data.frame(SummarizedExperiment::rowData(dat))
sam_table_pre <- as.data.frame(SummarizedExperiment::colData(dat))
counts_table <- as.data.frame(SummarizedExperiment::assay(
  dat, "counts"))[, rownames(sam_table_pre)]

counts_lcpm_species <- SummarizedExperiment::assay(dat , "log_counts_cpm") %>%
  as_data_frame()
counts_lcpm_genus <- counts_lcpm_species %>% upsample_counts(tax_table, "genus")
```

## Subset sepsis(+) infants into groups
```{R}
# Group 1 <= 16 days
# Group 2 <65 days
# Group 3 >65 days
pos_grp <- tibble("Sepsis(+) Grp1" = c("0177-1", "0707-1", "0832-1", "1354-1",
                                       rep(NA, 2)),
                  "Sepsis(+) Grp2" = c("0345-1", "0526-1", "0697-1",
                                       "0071-1", "1480-1", "0058-1")) %>%
  pivot_longer(cols = everything()) %>%
  filter(!is.na(value)) %>% arrange(name) %>%
  dplyr::rename("Group" = name, "Subject.ID" = value) %>%
  distinct(Subject.ID, .keep_all = TRUE)

sam_table <- left_join(sam_table_pre, pos_grp, by = "Subject.ID") %>%
  dplyr::relocate(Group)
sam_table$Group %<>% replace(is.na(sam_table$Group), "Sepsis(-)")
```

## Define timepoints
```{R}
# Pulled timepoints from Tyler's paper
params_mat <- tibble(start = c(0, 16, 32, 48, 64, 80, 96),
                     end = c(15, 31, 47, 63, 79, 95, 120),
                     timepoint = paste0("t", seq(0, 6)))
```

# Basic Data Exploration

## How many unique phyla, genera, species (post-“othering”)
```{R}
tax_table %>%
  # Remove "others"
  filter(species != "Other") %>%
  summarise(across(.fns = function(x) length(unique(x))))
```

## Do all samples have 10000+ reads?
```{R}
any(colSums(counts_table) < 10000)
```

## Obtain most abundant genera

Using average relative abundance
```{R}
obtain_gn <- function(counts_tab, tax_tab) {
  all_relabu_genus <- counts_tab |>
    upsample_counts(tax_table = tax_tab, higher_level = "genus") |>
    counts_to_relabu() |>
    rownames_to_column(var = "genus") |>
    filter(genus != "Other") |>
    rowwise(genus) |>
    # Sum everything but the first columm ("genus")
    summarise(allmeans = mean(c_across(starts_with("X"))),
              .groups = "drop") |>
    arrange(desc(allmeans))
  
  all_relabu_genus |> select(genus) |> unlist() |> unname() %>% 
    c(., "Other") %>% return()
}

best_genus <- obtain_gn(counts_table, tax_table)
```

## Line Plots of infants ages at clinic visits
```{R}
create_plot <- function(state = "pos", title_in = "Line plot of Sepsis(+) infant ages at clinic visits") {
  sam_table %>%
  filter(Sepsis.state == state) %>%
  group_by(Subject.ID) %>%
  ggplot2::ggplot(aes(x = Subject.ID, Age, color = Subject.ID)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 120, by = 10)) +
  theme_bw() +
  geom_hline(yintercept = c(0, 15, 31, 47, 63, 79, 95, 120), col = "red", alpha = 0.35,
             linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Infant age at visit (days)",
       x = "Subject ID",
       title = title_in)
ggsave(paste0("~/infant-microbiome/work/aodom/Sepsis/PaperFigs/lineplot_",
              state, ".png"),
       device = "png", units = "in", width = 6, height = 4)
}

create_plot("pos",
            "Line plot of Sepsis(+) infant ages at clinic visits")

create_plot("neg",
            "Line plot of Sepsis(-) infant ages at clinic visits")
```

## Individual line plot of sepsis infants with information
```{R}
# Read in all sick / sepsis time intervals, by subject ID (sepsis+ only)
sick_dates <- read_csv("Data/sick_dates.csv", show_col_types = FALSE,
                       col_types = cols("Start Sick" = col_date(format = "%m/%d/%y"),
                                        "Death Date" = col_date(format = "%m/%d/%y"),
                                        "Start Sepsis" = col_date(format = "%m/%d/%y"),
                                        "End Sepsis" = col_date(format = "%m/%d/%y")))

# Initialize data frame
init_dat <- sam_table %>%
  left_join(sick_dates, by = "Subject.ID") %>%
  filter(Sepsis.state == "pos") %>%
  arrange(Subject.ID, Age) %>% 
  mutate(Visit_Date = as.Date(Date.of.visit, format = "%m/%d/%Y"),
         birth = Visit_Date - Age,
         Sep_Age = `Start Sepsis` - birth,
         Death = `Death Date` - birth,
         Sep_End = `End Sepsis` - birth,
         Sick = `Start Sick` - birth) %>%
  group_by(Subject.ID)

ord_ID <- init_dat %>%
  summarise(diff = min(`Start Sepsis` - Visit_Date)) %>%
  arrange(diff) %>%
  pull(Subject.ID)
```

```{R}

# Create plot
init_dat %>%
  mutate(Subject.ID = factor(Subject.ID, levels = ord_ID)) %>%
  ggplot2::ggplot(aes(y = Age, x = Subject.ID)) +
  geom_point(col = "black") +
  geom_line(col = "black") +
  geom_hline(yintercept = params_mat$start, col = "grey", alpha = 0.35,
             linetype = "dashed") +
  geom_point(aes(y = `Sep_Age`), col = "cornflowerblue",
             position = position_nudge(x = 0.2)) +
  geom_point(aes(y = Sep_End), col = "cornflowerblue",
             position = position_nudge(x = 0.2)) +
  geom_segment(aes(y = `Sick`, yend = `Death`, xend = Subject.ID), col = "red",
               position = position_nudge(x = 0.2)) +
  theme_bw() +
  labs(y = "Infant Age (days)",
       x= "Subject ID",
       title = "Symptom development timeline, sepsis(+) infants",
       subtitle = paste0("Red lines indicate the period of general sickness.\n",
       "Blue dots indicate start/end of specifically sepsis-like symptoms.\n",
       "Black dots indicate sampling at clinic, connected by a black line."),
       caption = "Ordered by age diff. between sepsis start and last clinic visit")
ggsave(paste0("~/infant-microbiome/work/aodom/Sepsis/PaperFigs/lineplot_sepsis_dates.png"),
       device = "png", units = "in", width = 8, height = 6)

```

## How many visits per infant
```{R}
sam_table %>%
  dplyr::filter(Sepsis.state == "pos") %>%
  group_by(Subject.ID) %>%
  summarise(`Number of samples` = n())

sam_table %>%
  dplyr::filter(Sepsis.state == "neg") %>%
  group_by(Subject.ID) %>%
  summarise(`Number of samples` = n())
```

## Characterizing illness
```{R}
allnum <- "
0058-1	17
0071-1	44
0177-1	7
0345-1	32
0526-1	2
0697-1	2
0707-1	2
0832-1	19
1354-1	2
1480-1	0"
sympt_dur <- read_delim(allnum, 
                        show_col_types = FALSE,
                        col_names = FALSE)

stem(sympt_dur$X2)

```

# Visualization & plots

## Stacked bar plots
```{r}
get_stacked_data <- function(SE, sam_tab, tax_tab, cov1 = "Group",
                             cov2 = "timepoint") {
  counts_table_raw <- SummarizedExperiment::assay(SE, "counts") %>%
    as.data.frame() %>%
    select(sam_tab$Sample)
  relabu_table <- counts_table_raw %>%
    animalcules::upsample_counts(., tax_tab, "genus") %>%
    animalcules::counts_to_relabu() %>% t() %>% as.data.frame() %>%
    # Add grouping vars
    mutate(covariate1 = sam_tab[, cov1],
           covariate2 = sam_tab[, cov2]) %>%
    pivot_longer(!c(covariate1, covariate2), names_to = "taxon") %>%
    S4Vectors::aggregate(. ~ taxon + covariate1 + covariate2, ., mean)
  return(relabu_table)
}

stacked_dat <- get_stacked_data(dat, sam_tab = sam_table, tax_tab = tax_table)
```

### Plot both groups
```{R}
# Color palette
usepalette <- paletteer::palettes_d[["ggsci"]]["category20_d3"] |>
  unlist() |> unname() %>% 
  # Make "Other" show as grey
  .[seq_along(best_genus[-1])] %>% c(., "grey")

# Plot stacked barplot
myplot <- stacked_dat %>%
  mutate(Group = factor(covariate1)) %>% #,
  #                      levels = c("neg", "pos"),
  #                      labels = c("Control", "Sepsis"))) %>%
  mutate("Genus" = factor(taxon, levels = best_genus)) %>%
  dplyr::rename("Visit number" = covariate2,
                "Relative abundance" = `value`) %>%
  ggplot(aes(fill = Genus, x = `Visit number`, y = `Relative abundance`)) + 
    geom_bar(position = "stack", stat = "identity") +
  facet_grid(~Group) + theme_classic() +
  labs(title = "Relative abundances of genera",
       subtitle = "Control vs. Sepsis Infants (grouped)") +
  theme(legend.position = "bottom",
        #axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_fill_manual(values = usepalette) +
  coord_flip()
print(myplot)

ggsave(filename = "PaperFigs/stacked_barplot_groups.png",
  device = "png", width = 10, height = 6, units = "in", scale = 1)
```

## Stacked area chart

```{r function for stacked barplot}
# Creates relative abundance table by timepoint, HIV status
get_relabu <- function(stacked_df) {
  relabu_table <- stacked_df %>%
  dplyr::rename(Group = "covariate1", `Visit number` = "covariate2",
                `Relative abundance` = "value",
         genus = taxon) %>%
  relocate(Group, `Visit number`, genus, `Relative abundance`)
  return(relabu_table)
}
```

```{R}
# Function to make plot
genus_stacked <- function(input_df, genus_inp) {
  p <- input_df %>%
    mutate(Genus = factor(genus, levels = genus_inp)) %>%
    ggplot(aes(x = `Visit number`, y = `Relative abundance`,
               fill = Genus)) + 
    geom_area(alpha = 0.7, linewidth = .5, colour = "white") +
    scale_fill_manual(values = usepalette) +
    theme_classic() +
    facet_grid(rows = vars(Group)) +
    labs(title = paste("Microbe composition of samples"),
         subtitle = "Relative abundance across groups")
  p
  #if(mothinf == "mother") return(p + scale_x_continuous(breaks = c(0, 6)))
  #if(mothinf == "infant") return(p + scale_x_continuous(breaks = seq(0, 6)))
}
```

### Stacked area chart for infants
```{R}
input_df <- get_relabu(stacked_dat)
genus_stacked(input_df, best_genus)
ggsave(filename = "PaperFigs/stacked_area.png",
       width = 6, height = 4, units = "in",
       scale = 1)
```

## Alluvial plot

```{R}
plot_alluvial <- function(input_df, genus_inp) {
  p <- input_df %>%
    mutate(Genus = factor(genus, levels = genus_inp)) %>%
    # Get into alluvial format
    select(Group, `Visit number`, Genus, `Relative abundance`) %>%
    ggplot(aes(y = `Relative abundance`, x = `Visit number`, alluvium = Genus)) +
    ggalluvial::geom_alluvium(aes(fill = Genus, color = Genus),
                              width = 1/4, alpha = 0.7, decreasing = FALSE) +
    scale_fill_manual(values = usepalette) +
    scale_color_manual(values = usepalette) +
    theme_classic() +
    facet_grid(rows = vars(Group)) +
    labs(title = "Relative abundance of genera over time",
         subtitle = "By group")
  return(p)
}
```

```{R}
plot_alluvial(input_df, genus_inp = best_genus)
ggsave(filename = "PaperFigs/alluvial_genus.png",
       width = 6, height = 4, units = "in",
       scale = 1)
```

## Spaghetti plots
```{R}
create_sphaget <- function(this_taxon, tax_level = "genus",
                           sample_var = "Sample.ID",
                           xlabel = "Infant Age (Days)",
                           ylabel = "Relative Abundance (log CPM)",
                           path) {
  
  prefab_dat <- counts_table %>%
    upsample_counts(tax_table, tax_level) %>%
    counts_to_logcpm() %>%
    rownames_to_column("tax_level") %>%
    dplyr::filter(tax_level == this_taxon) %>%
    dplyr::select(-tax_level) %>% t() %>%
    as.data.frame() %>%
    tibble::rownames_to_column(sample_var) %>%
    left_join(sam_table, by = sample_var) %>%
    dplyr::rename(taxon = V1, "Sepsis state" = "Sepsis.state") %>%
    mutate(`Sepsis state` = factor(`Sepsis state`,
                                  levels = c("neg", "pos"),
                                  labels = c("sepsis(-)",
                                             "sepsis(+)")))
  
  prefab_dat %>%
    ggplot2::ggplot(aes(x = Age, y = taxon, group = Subject.ID,
                        color = `Group`)) +
    ggplot2::geom_line(alpha = 0.7) +
    ggplot2::geom_point(alpha = 0.7, size = 0.5) +
    ggplot2::labs(title = "Spaghetti plot of microbe abundance",
                  subtitle = this_taxon) +
    ggplot2::xlab(xlabel) +
    ggplot2::ylab(ylabel) +
    ggplot2::facet_grid(~`Sepsis state`) +
    ggplot2::theme_bw()
  
  # Save plot
  file.path(path, paste0("spaghetti_", this_taxon, ".png")) %>%
    ggplot2::ggsave(device = "png", width = 6, height = 4,
                    units = "in")
}

path <- "~/infant-microbiome/work/aodom/Sepsis/PaperFigs"
sapply(best_genus, create_sphaget, path = path)
```

# Statistical analyses

## Create MAE w/o filtering

```{R}
# Return MAE with no NA genera
filter_MAE <- function() {
  raw_MAE <- readRDS("Data/animalcules_raw_revised.rds")
  new_MAE <- raw_MAE
  all_rowdat <- rowData(new_MAE[["MicrobeGenetics"]]) 
  no_taxa <- all_rowdat %>%
    as.data.frame() %>%
    filter(is.na(genus)) %>%
    tibble::rownames_to_column("taxon") %>%
    pull(taxon)
  
  new_rowdat <- all_rowdat %>% as.data.frame() %>% 
    filter(!(species %in% no_taxa)) %>% DataFrame()
  
  new_dat <- assay(new_MAE[["MicrobeGenetics"]], "MGX") %>%
    as.data.frame() %>%
    tibble::rownames_to_column("rownames") %>%
    filter(!(rownames %in% no_taxa)) %>%
    tibble::column_to_rownames("rownames") %>%
    DataFrame()
  
  new_SE <- SummarizedExperiment(assays = SimpleList("MGX" = new_dat),
                       colData = colData(raw_MAE),
                       rowData = new_rowdat)
  
  raw_MAE[["MicrobeGenetics"]] <- new_SE 
  return(raw_MAE)
}

raw_dat <- filter_MAE()

```

## Two sample t-tests

### Function
```{R}
perform_t_test <- function(this_taxon, these_samples) {
  # Create dataset for testing
  test_data <- counts_lcpm_genus %>% rownames_to_column("taxa") %>% 
    filter(taxa == this_taxon) %>% select(-taxa) %>% t() %>% as.data.frame() %>%
    rownames_to_column("Sample.ID") %>% rename("abundance" = "V1") %>% 
    left_join(sam_table, by = "Sample.ID") %>%
    filter(Sample.ID %in% these_samples) %>%
    mutate(Group = factor(Sepsis.state)) %>% select(abundance, Group)
  
  # test if not enough obs
  test_enough <- test_data %>% group_by(Group) %>% summarise(total = n() < 2) %>%
    pull(total)
  if (length(test_enough) < 2 | sum(test_enough) > 0) return(NULL) 
  
  test_out <- t.test(abundance ~ Group, data = test_data,
                     alternative = "two.sided", var.equal = FALSE, paired = FALSE) %>%
    unlist() %>% magrittr::extract(seq(1, 7)) %>% as.data.frame() %>% 
    set_colnames("value") %>% mutate(value = as.numeric(value) %>% round(4))
  test_out %>% pull(value) %>% set_names(rownames(test_out)) %>% return()
}

```

### Apply function
```{R}
conduct_t_test_genera <- function(grp, time, these_samples) {
  age_lower <- params_mat %>% filter(timepoint %in% time) %>% pull(start)
  age_upper <- params_mat %>% filter(timepoint %in% time) %>% pull(end)
  controls <- sam_table %>% filter(Sepsis.state == "neg",
                                   Age > min(age_lower), Age <= max(age_upper)) %>%
    pull(Sample.ID)
  these_samples %<>% append(controls)
  all_genera <- rownames(counts_lcpm_genus)
  result <- plyr::ldply(all_genera,
                        function(x) perform_t_test(x, these_samples)) %>%
    mutate(genus = all_genera,
           adj.p = p.adjust(p.value, "bonferroni")) %>%
    arrange(`adj.p`) %>%
    relocate("genus", "adj.p", "p.value")
  result %>%
    write_csv(paste0("~/infant-microbiome/work/aodom/Sepsis/PaperFigs/",
                     "grp", grp, "time", paste(time, collapse = ""), ".csv"))
  return(result)
}

grp1_t0_samps <- c("X5264", "X4180", "X12014", "X1998")
conduct_t_test_genera(1, "t0", grp1_t0_samps)

grp2_t0_samps <- sam_table %>%
  filter(Group == "Sepsis(+) Grp2", Age <= params_mat$end[1]) %>% pull(Sample.ID)
conduct_t_test_genera(2, "t0", grp2_t0_samps)

grp2_t1_samps <- sam_table %>%
  filter(Group == "Sepsis(+) Grp2", Age > params_mat$start[1 + 1],
         Age <= params_mat$end[1 + 1]) %>% pull(Sample.ID)
conduct_t_test_genera(2, "t1", grp2_t1_samps)

grp2_t2_samps <- sam_table %>%
  filter(Group == "Sepsis(+) Grp2", Age > params_mat$start[2 + 1],
         Age <= params_mat$end[2 + 1]) %>% pull(Sample.ID)
conduct_t_test_genera(2, "t2", grp2_t2_samps)

grp2_t3_4_samps <- c("X1749", "X4654", "X6731", "X17642", "X7691", "X3975")
conduct_t_test_genera(2, c("t3", "t4"), grp2_t3_4_samps)

```
## Beta diversity analysis
### Function
```{R}
run_beta_test <- function(these_samples) {
  data_in <- subsetByColData(raw_dat,
                               which(raw_dat$Sample.ID %in% these_samples))
  diversity_beta_boxplot(data_in, "genus", "bray", "Sepsis.state") %>%
    print()
  output <- diversity_beta_test(data_in,
                    tax_level = "genus",
                    input_beta_method = "bray", #jaccard 
                    input_select_beta_condition = "Sepsis.state",
                    input_select_beta_stat_method = "Kruskal-Wallis")
  return(output)
}
```

### Results
```{R}
beta_res <- function(grp, time, these_samples) {
  # pull control samples
  age_lower <- params_mat %>% filter(timepoint %in% time) %>% pull(start)
  age_upper <- params_mat %>% filter(timepoint %in% time) %>% pull(end)
  controls <- sam_table %>% filter(Sepsis.state == "neg",
                                   Age > min(age_lower), Age <= max(age_upper)) %>%
    pull(Sample.ID)
  these_samples %<>% append(controls)
  
  # Run test
  fileout <- paste0("~/infant-microbiome/work/aodom/Sepsis/PaperFigs/betatest_",
                     "grp", grp, "time", paste(time, collapse = ""), ".csv")
  res <- run_beta_test(these_samples) 
  res %>% write_csv(fileout)
  return(res)
}

# Group 1
grp1_t0_samps <- c("X5264", "X4180", "X12014", "X1998")
beta_res(1, "t0", grp1_t0_samps)

# Group 2
grp2_t0_samps <- sam_table %>%
  filter(Group == "Sepsis(+) Grp2", Age <= params_mat$end[1]) %>% pull(Sample.ID)
beta_res(2, "t0", grp2_t0_samps)

grp2_t1_samps <- sam_table %>%
  filter(Group == "Sepsis(+) Grp2", Age > params_mat$start[1 + 1],
         Age <= params_mat$end[1 + 1]) %>% pull(Sample.ID)
beta_res(2, "t1", grp2_t1_samps)

grp2_t2_samps <- sam_table %>%
  filter(Group == "Sepsis(+) Grp2", Age > params_mat$start[2 + 1],
         Age <= params_mat$end[2 + 1]) %>% pull(Sample.ID)
beta_res(2, "t2", grp2_t2_samps)

grp2_t3_4_samps <- c("X1749", "X4654", "X6731", "X17642", "X7691")
beta_res(2, c("t3", "t4", "t5"), grp2_t3_4_samps)
```


