---
title: "Reorganize Data"
author: "Aubrey Odom-Mabey"
date: "2022-11-21"
output: html_document
---


# Setup
```{R}
suppressPackageStartupMessages({
  # General use
  library(tidyverse)
  library(knitr)
  library(magrittr)
  # Data formats
  library(animalcules)
  library(MultiAssayExperiment)
  library(SummarizedExperiment)
  # Add assays
  library(TBSignatureProfiler)
  library(MetaScope)
})
```

# Fix MetaScope data
Only run this once!!
```{R}
#stem <- "~/infant-microbiome/work/aodom/Sepsis"
#all_files <- list.files(file.path(stem, "run_metascope/metascope_out"),
#                        full.names = TRUE, pattern = "*.metascope_id.csv")
#Sys.setenv(ENTREZ_KEY = "01d22876be34df5c28f4aedc479a2674c809")
#now <- Sys.time()
#out_MAE <- MetaScope::convert_animalcules(all_files,
#                               annot_path = file.path(stem, "Data/Cleaned_metadata_allsamp.csv"),
#                               which_annot_col = 1,
#                               end_string = ".metascope_id.csv",
#                               NCBI_key = NULL)
#Sys.time() - now 
#saveRDS(out_MAE, file.path(stem, "Data/raw_nofilter.RDS"))
```

# Initial data extraction
```{r plotting}
# Read in MAE of data
OG_dat <- readRDS("raw_nofilter.RDS")
dat <- OG_dat[["MicrobeGenetics"]]

# Extract metadata, taxonomic info, and counts
tax_table <- as.data.frame(SummarizedExperiment::rowData(dat))
sam_table <- as.data.frame(SummarizedExperiment::colData(dat))
# This is because there was new data that came around
sam_table <- read.csv("Cleaned_metadata_allsamp.csv") %>%
  arrange(factor(Sample.ID, levels = rownames(sam_table))) %>%
  mutate(rownames = Sample.ID) %>%
  column_to_rownames("rownames")
counts_table <- as.data.frame(SummarizedExperiment::assay(
  dat, "MGX"))[, rownames(sam_table)]
```

# Revise raw data
```{R}
MAE_obj <- OG_dat
# This is how to get log CPM (and extract SE obj from multi-assay experiment object)
# This will now be a summarized experiment

# Fixing data - converting to by genus instead of species
se_colData <- sam_table
se_colData$Sample <- rownames(se_colData)
se_colData %<>% relocate(Sample)
```

```{R}
se_rowData  <- rowData(MAE_obj[["MicrobeGenetics"]]) %>%
  dplyr::as_tibble() %>%
  dplyr::mutate(species = stringr::str_replace_all(species, " ", "_"),
                species = stringr::str_remove_all(species, "\\["),
                species = stringr::str_remove_all(species, "\\]")) %>%
  as.data.frame()
# Replace species that are others with "sp."
ind <- se_rowData$species == "others"
se_rowData$species[ind] <- paste(se_rowData$genus[ind], "sp.", sep = "_")
# Replace genus that are others with species information
ind <- se_rowData$genus == "others" & !is.na(se_rowData$genus)
all_split <- sapply(strsplit(se_rowData$species, "_"), function(x) x[[1]])
se_rowData$genus[ind] <- all_split[ind]
```

```{R}
## Change to reflect starting letter of sample columns
starting_char <- "X"

# Proceed as usual
countsdat <- assay(MAE_obj[["MicrobeGenetics"]], "MGX") %>%
  dplyr::as_tibble() %>%
  #rename_with(function(x) sapply(
  #  x, function(y) paste0("S",str_split(y, "_")[[1]][1]))) %>%
  bind_cols(as_tibble(se_rowData), .) %>%
  arrange(species) %>%
  dplyr::group_by(species) %>%
  summarise(across(starts_with(starting_char, ignore.case = FALSE), .fns = sum)) %>%
  tibble::column_to_rownames("species")

se_mgx <- countsdat %>% base::data.matrix() %>% S4Vectors::SimpleList() %>%
  magrittr::set_names("MGX")
```

```{R}
se_rowData %<>%
  distinct(species, .keep_all = TRUE) %>%
  filter(species %in% rownames(countsdat)) %>%
  arrange(species) %>%
  dplyr::mutate(rownames = species) %>%
  tibble::column_to_rownames("rownames") %>%
  S4Vectors::DataFrame()
```

```{R}
# Check:
#all.equal(rownames(se_rowData), rownames(countsdat))
#all.equal(colnames(countsdat), rownames(se_colData))

microbe_se <- SummarizedExperiment::SummarizedExperiment(
  assays = se_mgx, colData = se_colData, rowData = se_rowData)
MAE_out <- MultiAssayExperiment::MultiAssayExperiment(
  experiments = S4Vectors::SimpleList(MicrobeGenetics = microbe_se),
  colData = se_colData)

saveRDS(MAE_out, file = "animalcules_raw_revised.rds")
```

# Filtering

The purpose of this code is to take the final formatted Multi-Assay Experiment output by Animalcules and label as "Other" all the taxons belonging to genera that represent <1% average relative abundances across samples. 

The resulting data object is a SummarizedExperiment object saved as "animalcules_1pct.rds"

## Extract data
```{r plotting}
# Read in MAE of data
OG_dat <- readRDS("animalcules_raw_revised.rds")
dat <- OG_dat[["MicrobeGenetics"]]

# Extract metadata, taxonomic info, and counts
tax_table <- as.data.frame(SummarizedExperiment::rowData(dat))
sam_table <- as.data.frame(SummarizedExperiment::colData(dat))
counts_table <- as.data.frame(SummarizedExperiment::assay(
  dat, "MGX"))[, rownames(sam_table)]
```

## Identify species < 0.01 average relative genus abundance as other
```{R}
## Define percent
pct_cutoff <- 0.05 # This is 0.05% NOT 0.005%

# Extract metadata, taxonomic informtation, and counts
#tax_table
#sam_table

all_relabu_genus <- counts_table |>
  as.matrix() |>
  # Get rel abu within samokes
  prop.table(margin = 2) |>
  as_tibble() |>
  bind_cols(genus = tax_table$genus) |>
  relocate(genus) |>
  group_by(genus) |>
  # Sum rel abu within samples/columns for genera
  summarise(across(.fns = sum, .cols = dplyr::everything())) %>%
  # Sum everything but the first columm ("genus")
  mutate(allmeans = apply(.[,-1], 1, mean)) |>
  select(genus, allmeans) |>
  mutate(genus = replace(genus, is.na(genus), "Unknown")) |>
  arrange(desc(allmeans)) |>
  mutate(lessthan1pct = allmeans < pct_cutoff/10)

# Identify species in other
othergenera <- all_relabu_genus %>%
  filter(lessthan1pct == TRUE) |>
  select(genus) |> unlist() |> unname()

```

## Use the identified species to update the tax, species tables
```{R}
# Replace tax table
tax_table_other <- tax_table |>
  select(!strain) |>
  mutate(genus = replace(genus, is.na(genus), "Unknown"),
         species = replace(species, genus %in% othergenera, "Other"),
         genus = replace(genus, genus %in% othergenera, "Other"),
         family = replace(genus, genus %in% othergenera, "Other"),
         order = replace(genus, genus %in% othergenera, "Other"),
         class = replace(genus, genus %in% othergenera, "Other"),
         phylum = replace(genus, genus %in% othergenera, "Other"),
         superkingdom = replace(genus, genus %in% othergenera, "Other"),
         # REPLACE SHIGELLA
         genus = replace(genus, genus %in% c("Shigella"), "Escherichia"),
         species = replace(species, species %in% c("Shigella_dysenteriae",
                                                   "Shigella_flexneri"), "Escherichia_coli"),
         # REPLACE KNOWN STREP
         species = replace(species, species == "Streptococcus_agalactiae", "Streptococcus_pneumoniae"),
         species = replace(species, species %in% c("Streptococcus_pseudoporcinus",
                                                   "Streptococcus_sobrinus"), "Streptococcus_agalactiae"))

# Resum the counts table
counts_other <- counts_table |>
  bind_cols(species = tax_table_other$species) |>
  group_by(species) |>
  summarise(across(.fns = sum)) |>
  tibble::column_to_rownames("species")

# Adjust tax table accordingly
tax_table_other2 <- tax_table_other %>%
  distinct(species, .keep_all = TRUE) %>%
  arrange(species)

rownames(tax_table_other2) <- tax_table_other2$species

```

## Create SE object
```{R}
microbe_other <- SummarizedExperiment(
  assays = list(counts = counts_other),
  rowData = tax_table_other2, colData = sam_table)

# Add assays using TBSP
dat <- TBSignatureProfiler::mkAssay(microbe_other, log = TRUE, 
                                    counts_to_CPM = TRUE,
                                    input_name = "counts")

MAE_out <- MultiAssayExperiment::MultiAssayExperiment(
    experiments = S4Vectors::SimpleList(MicrobeGenetics = dat),
    colData = sam_table)

saveRDS(MAE_out, file = paste0("animalcules_", pct_cutoff, "pct.rds"))
```

## How many genera?
```{R}
length(unique(tax_table$genus))

length(unique(tax_table_other2$genus))
```
